---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Hero from '../../components/Hero.astro';
import FeatureGrid from '../../components/FeatureGrid.astro';
import CTASection from '../../components/CTASection.astro';
import Footer from '../../components/Footer.astro';

export const prerender = true;

export async function getStaticPaths() {
  const locations = await getCollection('locations');
  return locations.map(entry => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// Parse markdown content into sections for dynamic rendering
const rawContent = entry.body;
const sections: any[] = [];
let currentSection: any = { title: '', content: [], type: 'content' };
let heroData: { headline?: string; subheadline?: string } = {};

const lines = rawContent.split('\n');
let inHeroSection = false;
let skipSection = false;

for (let i = 0; i < lines.length; i++) {
  const line = lines[i];
  
  // Skip the H1 title as it's in the hero
  if (line.startsWith('# ') && !line.startsWith('## ')) {
    continue;
  }
  
  // Check for Hero Section
  if (line.startsWith('## Hero Section')) {
    inHeroSection = true;
    skipSection = true;
    continue;
  } else if (line.startsWith('## ') && inHeroSection) {
    inHeroSection = false;
    skipSection = false;
  }
  
  // Process hero section data
  if (inHeroSection) {
    if (line.startsWith('Headline:')) {
      heroData.headline = line.substring(9).trim();
    } else if (line.startsWith('Subheadline:')) {
      heroData.subheadline = line.substring(12).trim();
    }
    continue;
  }
  
  if (skipSection) {
    continue;
  }
  
  // New H2 section
  if (line.startsWith('## ')) {
    if (currentSection.content.length > 0 || currentSection.title) {
      sections.push({ ...currentSection });
    }
    const title = line.substring(3).trim();
    currentSection = { 
      title, 
      content: [],
      type: 'content'
    };
    
    // Check for special section types
    if (title.toLowerCase().includes('industries')) {
      currentSection.type = 'industries';
    } else if (title.toLowerCase().includes('service area') || title.toLowerCase().includes('coverage')) {
      currentSection.type = 'service-area';
    } else if (title.toLowerCase().includes('investment') || title.toLowerCase().includes('package') || title.toLowerCase().includes('pricing')) {
      currentSection.type = 'packages';
    } else if (title.toLowerCase().includes('question') || title.toLowerCase().includes('faq')) {
      currentSection.type = 'faq';
    } else if (title.toLowerCase().includes('why') || title.toLowerCase().includes('choose')) {
      currentSection.type = 'features';
    }
  } 
  // Check for H3 headers
  else if (line.startsWith('### ')) {
    const h3Text = line.substring(4).trim();
    currentSection.content.push({ type: 'h3', text: h3Text });
  }
  // Bullet points
  else if (line.startsWith('- ') || line.startsWith('* ')) {
    const text = line.substring(2).trim();
    currentSection.content.push({ type: 'bullet', text });
  }
  // Bold lines (e.g., **Core Wilmington:**)
  else if (line.startsWith('**') && line.includes(':**')) {
    currentSection.content.push({ type: 'bold-line', text: line });
  }
  // Regular paragraph
  else if (line.trim()) {
    currentSection.content.push({ type: 'paragraph', text: line });
  }
}

// Add the last section
if (currentSection.content.length > 0 || currentSection.title) {
  sections.push({ ...currentSection });
}

// Process industries section
const processIndustries = (section: any) => {
  const industries: any[] = [];
  let currentIndustry: any = null;
  
  section.content.forEach((item: any) => {
    if (item.type === 'h3') {
      if (currentIndustry) industries.push(currentIndustry);
      currentIndustry = {
        title: item.text,
        description: ''
      };
    } else if (item.type === 'paragraph' && currentIndustry) {
      currentIndustry.description += item.text + ' ';
    } else if (item.type === 'bullet') {
      // Handle bullet points as simple industry items
      const parts = item.text.split(':');
      industries.push({
        title: parts[0].replace(/\*\*/g, '').trim(),
        description: parts[1]?.trim() || ''
      });
    }
  });
  
  if (currentIndustry) industries.push(currentIndustry);
  return industries;
};

// Extract city name from slug or title
const cityName = entry.data.city || entry.slug.replace(/-web-design|-nc/g, '').replace(/-/g, ' ')
  .split(' ')
  .map(word => word.charAt(0).toUpperCase() + word.slice(1))
  .join(' ');

const pageTitle = entry.data.title || `${cityName} Web Design & SEO | Beach Bird Studios`;
const pageDescription = entry.data.description || `Professional web design and SEO services in ${cityName}, NC. Custom websites, AI development, and proven SEO strategies for local businesses.`;

// Features for location pages
const locationFeatures = [
  {
    icon: 'map-pin',
    title: `Local ${cityName} Expertise`,
    description: `We understand the ${cityName} market and what local customers are searching for online.`,
    iconColor: 'blue'
  },
  {
    icon: 'zap',
    title: 'Fast Turnaround',
    description: 'Get your website live in weeks, not months. Your business can\'t afford to wait.',
    iconColor: 'yellow'
  },
  {
    icon: 'trending-up',
    title: 'Proven Results',
    description: `Help ${cityName} businesses rank higher, get more traffic, and convert more customers.`,
    iconColor: 'green'
  },
  {
    icon: 'shield-check',
    title: 'Reliable Support',
    description: 'Local support you can count on. We\'re here when you need us.',
    iconColor: 'cyan'
  },
  {
    icon: 'palette',
    title: 'Custom Design',
    description: 'Unique designs that make your business stand out from competitors.',
    iconColor: 'purple'
  },
  {
    icon: 'search',
    title: 'SEO Included',
    description: 'Every website comes with SEO optimization to help you rank locally.',
    iconColor: 'orange'
  }
];
---

<Layout 
  title={pageTitle} 
  description={pageDescription}
  structuredDataType="WebPage"
  structuredData={{
    breadcrumb: [
      { name: 'Home', url: '/' },
      { name: 'Locations', url: '/locations' },
      { name: cityName, url: `/locations/${entry.slug}` }
    ]
  }}
>
  <Header />
  
  <!-- Hero Section -->
  <Hero
    headline={heroData.headline || `${cityName} Web Design & SEO Services`}
    subheadline={heroData.subheadline || `Looking for professional web design in ${cityName}? We create stunning websites that convert visitors into customers.`}
    primaryCTA={{ text: 'Get Your Free Consultation', href: '/contact' }}
    secondaryCTA={{ text: 'View Our Services', href: '/services' }}
  />
  
  <main>
    <!-- Introduction Section -->
    <section class="section-padding bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="max-w-3xl mx-auto text-center">
          <h2 class="text-3xl sm:text-4xl font-chillax font-bold text-gray-900 mb-6">
            Your Local {cityName} Web Design Partner
          </h2>
          <p class="text-lg text-gray-600 mb-8">
            Beach Bird Studios specializes in creating beautiful, fast websites for {cityName} businesses. 
            Whether you need a simple site or a comprehensive 100+ page web presence, we deliver results 
            that help you dominate local search results.
          </p>
        </div>
      </div>
    </section>
    
    <!-- Features Grid -->
    <section class="section-padding bg-gray-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-3xl sm:text-4xl font-chillax font-bold text-gray-900 mb-4">
            Why {cityName} Businesses Choose Us
          </h2>
          <p class="text-lg text-gray-600 max-w-3xl mx-auto">
            We combine local market knowledge with proven web design and SEO strategies.
          </p>
        </div>
        
        <FeatureGrid features={locationFeatures} columns={3} variant="cards" />
      </div>
    </section>
    
    <!-- Dynamic Content Sections -->
    {sections.map((section, index) => {
      // Alternate backgrounds between white and gray
      const bgClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
      
      return (
        <section class={`section-padding ${bgClass}`}>
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            {section.title && (
              <div class="text-center mb-12">
                <h2 class="text-3xl sm:text-4xl font-chillax font-bold text-gray-900 mb-4">
                  {section.title}
                </h2>
              </div>
            )}
            
            {/* Industries Grid */}
            {section.type === 'industries' && (
              <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {processIndustries(section).map((industry: any) => (
                  <div class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow border border-gray-100 hover:border-beach-blue/20">
                    <div class="w-12 h-12 bg-gradient-to-br from-beach-blue to-beach-blue/70 rounded-lg flex items-center justify-center mb-4">
                      <i data-lucide="briefcase" class="w-6 h-6 text-white"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-3">{industry.title}</h3>
                    <p class="text-gray-600 leading-relaxed">{industry.description}</p>
                  </div>
                ))}
              </div>
            )}
            
            {/* Service Area Coverage */}
            {section.type === 'service-area' && (
              <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl p-8 shadow-lg border border-gray-100">
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {section.content.map((item: any) => {
                      if (item.type === 'bold-line') {
                        const parts = item.text.split(':');
                        const title = parts[0].replace(/\*\*/g, '').trim();
                        const locations = parts[1]?.trim() || '';
                        return (
                          <div class="flex items-start space-x-3">
                            <div class="w-8 h-8 bg-beach-blue rounded-full flex items-center justify-center flex-shrink-0">
                              <i data-lucide="map-pin" class="w-4 h-4 text-white"></i>
                            </div>
                            <div>
                              <h4 class="font-semibold text-gray-900 mb-1">{title}</h4>
                              <p class="text-gray-600 text-sm">{locations}</p>
                            </div>
                          </div>
                        );
                      } else if (item.type === 'paragraph') {
                        return <p class="text-gray-600 md:col-span-2">{item.text}</p>;
                      }
                      return null;
                    })}
                  </div>
                </div>
              </div>
            )}
            
            {/* Investment Packages Section */}
            {section.type === 'packages' && (
              <div class="max-w-5xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                  {section.content.filter((item: any) => item.type === 'h3').map((item: any, idx: number) => {
                    const descriptionIdx = section.content.findIndex((c: any, i: number) => i > section.content.indexOf(item) && c.type === 'paragraph');
                    const description = descriptionIdx !== -1 ? section.content[descriptionIdx].text : '';
                    const isFeatured = idx === 1; // Middle card featured
                    
                    return (
                      <div class={`rounded-xl p-8 shadow-lg hover:shadow-xl transition-shadow ${isFeatured ? 'bg-gradient-to-br from-beach-blue to-beach-blue/90 text-white scale-105' : 'bg-white border border-gray-100'}`}>
                        {isFeatured && (
                          <div class="text-center mb-4">
                            <span class="bg-beach-yellow text-beach-dark px-4 py-1 rounded-full text-sm font-semibold">MOST POPULAR</span>
                          </div>
                        )}
                        <h3 class={`text-2xl font-bold mb-4 ${isFeatured ? 'text-white' : 'text-gray-900'}`}>{item.text}</h3>
                        <p class={`mb-6 ${isFeatured ? 'text-blue-50' : 'text-gray-600'}`}>{description}</p>
                        <a href="/contact" class={`block text-center py-3 px-6 rounded-lg font-semibold transition-all ${isFeatured ? 'bg-beach-yellow text-beach-dark hover:bg-yellow-400' : 'bg-beach-blue text-white hover:bg-blue-600'}`}>
                          Get Started
                        </a>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
            
            {/* FAQ Section */}
            {section.type === 'faq' && (
              <div class="max-w-3xl mx-auto">
                <div class="space-y-4">
                  {section.content.filter((item: any) => item.type === 'paragraph' && item.text.startsWith('**')).map((item: any, idx: number) => {
                    const question = item.text.replace(/\*\*/g, '').replace(/\?.*/, '?');
                    const answerIdx = section.content.findIndex((c: any, i: number) => i > section.content.indexOf(item) && c.type === 'paragraph' && !c.text.startsWith('**'));
                    const answer = answerIdx !== -1 ? section.content[answerIdx].text : '';
                    
                    return (
                      <div class="bg-white rounded-lg shadow-md hover:shadow-lg transition-shadow">
                        <div class="p-6">
                          <h3 class="text-lg font-semibold text-gray-900 mb-3">{question}</h3>
                          <p class="text-gray-600 leading-relaxed">{answer}</p>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
            
            {/* Features/Why Choose Us Section */}
            {section.type === 'features' && (
              <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                {section.content.filter((item: any) => item.type === 'h3').map((item: any) => {
                  const descriptionIdx = section.content.findIndex((c: any, i: number) => i > section.content.indexOf(item) && c.type === 'paragraph');
                  const description = descriptionIdx !== -1 ? section.content[descriptionIdx].text : '';
                  
                  return (
                    <div class="flex items-start space-x-4">
                      <div class="w-12 h-12 bg-gradient-to-br from-beach-blue to-beach-blue/70 rounded-lg flex items-center justify-center flex-shrink-0">
                        <i data-lucide="check-circle" class="w-6 h-6 text-white"></i>
                      </div>
                      <div>
                        <h3 class="text-xl font-bold text-gray-900 mb-2">{item.text}</h3>
                        <p class="text-gray-600 leading-relaxed">{description}</p>
                      </div>
                    </div>
                  );
                })}
              </div>
            )}
            
            {/* Regular Content Section */}
            {section.type === 'content' && (
              <div class="prose prose-lg max-w-4xl mx-auto">
                {section.content.map((item: any) => {
                  if (item.type === 'h3') {
                    return <h3 class="text-2xl font-semibold text-gray-800 mb-4 mt-8">{item.text}</h3>;
                  } else if (item.type === 'paragraph') {
                    // Parse for bold text and inline links
                    const htmlText = item.text
                      .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                      .replace(/\[([^\]]+)\]/g, '<a href="/contact" class="text-beach-blue hover:text-blue-700 underline">$1</a>');
                    return <p class="text-lg text-gray-600 mb-6 leading-relaxed" set:html={htmlText}></p>;
                  } else if (item.type === 'bullet') {
                    const htmlText = item.text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    return (
                      <ul class="list-disc pl-6 mb-2 space-y-1">
                        <li class="text-gray-600" set:html={htmlText}></li>
                      </ul>
                    );
                  }
                  return null;
                })}
              </div>
            )}
          </div>
        </section>
      );
    })}
    
    <!-- Services CTA -->
    <section class="section-padding bg-gray-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="text-center mb-12">
          <h2 class="text-3xl sm:text-4xl font-chillax font-bold text-gray-900 mb-4">
            Our Services for {cityName} Businesses
          </h2>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-5xl mx-auto">
          <a href="/services/custom-website-design" class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
            <div class="w-12 h-12 bg-beach-blue/10 rounded-lg flex items-center justify-center mb-4">
              <i data-lucide="palette" class="w-6 h-6 text-beach-blue"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Custom Web Design</h3>
            <p class="text-gray-600 mb-4">Beautiful, fast websites built specifically for your business.</p>
            <span class="text-beach-blue font-semibold">Learn More →</span>
          </a>
          
          <a href="/services/ai-website-development" class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
            <div class="w-12 h-12 bg-beach-blue/10 rounded-lg flex items-center justify-center mb-4">
              <i data-lucide="cpu" class="w-6 h-6 text-beach-blue"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">AI Website Development</h3>
            <p class="text-gray-600 mb-4">100+ page websites to dominate search results.</p>
            <span class="text-beach-blue font-semibold">Learn More →</span>
          </a>
          
          <a href="/services/seo-services" class="bg-white rounded-xl p-6 shadow-lg hover:shadow-xl transition-shadow">
            <div class="w-12 h-12 bg-beach-blue/10 rounded-lg flex items-center justify-center mb-4">
              <i data-lucide="search" class="w-6 h-6 text-beach-blue"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">SEO Services</h3>
            <p class="text-gray-600 mb-4">Optimize your existing website for better rankings.</p>
            <span class="text-beach-blue font-semibold">Learn More →</span>
          </a>
        </div>
      </div>
    </section>
    
    <!-- Final CTA -->
    <CTASection
      headline={`Ready to Grow Your ${cityName} Business Online?`}
      description="Let's create a website that actually works for your business. Get started with a free consultation."
      primaryCTA={{ text: 'Get Your Free Consultation', href: '/contact' }}
      secondaryCTA={{ text: 'Call 910-512-6990', href: 'tel:910-512-6990' }}
      variant="gradient"
    />
  </main>
  
  <Footer />
</Layout>